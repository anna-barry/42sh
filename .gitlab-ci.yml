---

default:
  image: registry.cri.epita.fr/cri/infrastructure/nixpie/nixos-pie
  before_script:
    - mkdir -p /tmp /var/tmp
    - meson setup -Ddoc=true builddir

stages:
  - build
  - test
  - qa
  - doc

build:
  stage: build
  script:
    - meson compile -C builddir
  artifacts:
    paths:
      - builddir/42sh
    expose_as: 42sh

Anna_test_lexer:
  stage: test
  script:
    - tests/run_tests_2
  
Anna_test_variables:
  stage: test
  script:
    - tests/tests_variables

Anna_test_for:
  stage: test
  script:
    - tests/run_tests_lexer_for

test:
  stage: test
  dependencies:
    - build
  script:
    - tests/run_tests builddir/42sh

week_1:
  stage: test
  dependencies:
    - build
  script:
    - tests/week1/tests_if_echo builddir/42sh

clang-format:
  stage: qa
  needs: []
  before_script: []
  script:
    - find . -type f -name '*.[ch]' -exec clang-format --style=file -i {} ';'
    - git diff --exit-code
  after_script:
    - git diff > diff
  artifacts:
    paths:
      - diff
    expose_as: clang-format diff
    when: on_failure

doc:
  stage: doc
  needs: []
  script:
    - meson compile -C builddir doxygen_doc
  artifacts:
    paths:
      - builddir/doxygen_doc
    expose_as: documentation
